/*!
 * @preserve
 * Screentime.js | v0.1
 * Copyright (c) 2014 Rob Flaherty (@robflaherty)
 * Licensed under the MIT and GPL licenses.
 */
(function(e,t,n){var r={fields:[],percentOnScreen:"50%",reportInterval:10,googleAnalytics:false,callback:function(){}};e.screentime=function(i){function h(){return Math.round(Math.random()*2147483647)}function p(t){this.selector=t.selector;$elem=this.$elem=e(t.selector);this.name=t.name;this.top=$elem.offset().top;this.height=$elem.height();this.bottom=this.top+this.height;this.width=$elem.width()}function d(){var n=e(t);this.top=n.scrollTop();this.height=n.height();this.bottom=this.top+this.height;this.width=n.width()}function v(e,t){if(l){ga("send","event","Screentime","Time on Screen",e,parseInt(t,10),{nonInteraction:true})}if(c){_gaq.push(["_trackEvent","Screentime","Time on Screen",e,parseInt(t,10),true])}}function m(e,t){var n,r,s;if(t.bottom<=e.bottom&&t.top>=e.top){return true}if(t.height>e.height){n=e.bottom-t.top>e.height/2&&t.bottom-e.top>e.height/2;if(n){return true}}r=t.height*(i.percentOnScreen/100);s=e.bottom-r>=t.top&&t.bottom-r>e.top;return s}function g(){var t=new d;e.each(o,function(e,n){if(m(t,n)){u[e]+=1;s[e]+=1}})}function y(){var t={};e.each(s,function(e,n){if(n>0){t[e]=n;s[e]=0;if(i.googleAnalytics){v(e,n)}}});if(!e.isEmptyObject(t)){i.callback.call(this,t)}}function w(){if(!f){g();f=true}a=setInterval(function(){g()},1e3);reporter=setInterval(function(){y()},i.reportInterval*1e3)}function E(){clearInterval(a);clearInterval(reporter)}function S(){e.each(i.fields,function(t,n){if(e(n.selector).length){var r=new p(n);o[r.name]=r;s[r.name]=0;u[r.name]=0}});w();visibly.onHidden(function(){E()});visibly.onVisible(function(){E();w()})}i=e.extend({},r,i);i.percentOnScreen=parseInt(i.percentOnScreen.replace("%",""),10);var s={};var o={};var u={};var a=null;var f=false;var l,c;if(!i.fields.length){return}if(i.googleAnalytics){if(typeof ga==="function"){l=true}if(typeof _gaq!=="undefined"&&typeof _gaq.push==="function"){c=true}}(function(){t.visibly={q:n,p:undefined,prefixes:["webkit","ms","o","moz","khtml"],props:["VisibilityState","visibilitychange","Hidden"],m:["focus","blur"],visibleCallbacks:[],hiddenCallbacks:[],genericCallbacks:[],_callbacks:[],cachedPrefix:"",fn:null,onVisible:function(e){if(typeof e=="function"){this.visibleCallbacks.push(e)}},onHidden:function(e){if(typeof e=="function"){this.hiddenCallbacks.push(e)}},getPrefix:function(){if(!this.cachedPrefix){for(var e=0;b=this.prefixes[e++];){if(b+this.props[2]in this.q){this.cachedPrefix=b;return this.cachedPrefix}}}},visibilityState:function(){return this._getProp(0)},hidden:function(){return this._getProp(2)},visibilitychange:function(e){if(typeof e=="function"){this.genericCallbacks.push(e)}var t=this.genericCallbacks.length;if(t){if(this.cachedPrefix){while(t--){this.genericCallbacks[t].call(this,this.visibilityState())}}else{while(t--){this.genericCallbacks[t].call(this,arguments[0])}}}},isSupported:function(e){return this.cachedPrefix+this.props[2]in this.q},_getProp:function(e){return this.q[this.cachedPrefix+this.props[e]]},_execute:function(e){if(e){this._callbacks=e==1?this.visibleCallbacks:this.hiddenCallbacks;var t=this._callbacks.length;while(t--){this._callbacks[t]()}}},_visible:function(){t.visibly._execute(1);t.visibly.visibilitychange.call(t.visibly,"visible")},_hidden:function(){t.visibly._execute(2);t.visibly.visibilitychange.call(t.visibly,"hidden")},_nativeSwitch:function(){this[this._getProp(2)?"_hidden":"_visible"]()},_listen:function(){try{if(!this.isSupported()){if(this.q.addEventListener){t.addEventListener(this.m[0],this._visible,1);t.addEventListener(this.m[1],this._hidden,1)}else{if(this.q.attachEvent){this.q.attachEvent("onfocusin",this._visible);this.q.attachEvent("onfocusout",this._hidden)}}}else{this.q.addEventListener(this.cachedPrefix+this.props[1],function(){t.visibly._nativeSwitch.apply(t.visibly,arguments)},1)}}catch(e){}},init:function(){this.getPrefix();this._listen()}};this.visibly.init()})();S()}})(jQuery,window,document)
